---
title: "Cavity project analyses"
author: "Juan S Vargas"
date: "2/16/2022"
output: html_document
bibliography: biblio.bib
df_print: "kable"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```
Load libraries. We will use the `tidyverse` suite for data management, as well as the `vegan` package for community ecology analyses. 
```{r packages}
library(tidyverse)
library(vegan)
library(cowplot)
```

# Summary
We analyzed the species that visit natural cavities in the forest, and artificial habitats -- originally designed as bat refugia -- located in reforestation and regeneration plots. The species richness and diversity were higher in the forest compared to the plots. Some of the differences are related simply to the vegetation, some species that were frequently observed in the regeneration plots are more associated with open areas. The behaviors observed were also different. Species that rely on hollow trees and dead wood for foraging spend longer in natural cavities than in artificial habitats (e.g. coatis, tamanduas). Species interact frequently with artificial habitats, exploring while foraging, or in some cases as shelter. Species like opossums and coatis sheltered inside, and occasionally peccaries can also shelter below the boxes. The artificial habitats may also serve as marking sites, particularly for ocelots.

# Data extraction

We used the Timelapse software (Greenberg) to extract the metadata associated with the videos. This software allows to correct errors in time set, and differences in the timezone with flexibility. There were indeed a few errors, mostly associated with the timezone, which was not the same across cameras. Additionally there were one hour changes due to daylight savings, I'm not sure if this error came up only because of _my_ computer's locale. In any case, I was able to fix these problems. The main database is in a csv file called "cavity_monitoring_database.csv".
The database includes multiple videos for a single event, but there is a variable called "Event" that includes the number of videos in each episode, so I can select just one out of each series to keep only independent events.

```{r import data}
database <- read_csv('cavity_monitoring_database.csv') %>% filter(DeleteFlag==FALSE) %>% 
   select(DateTime, Station, Species, SpNumber, Individual, Event, Behaviour)

station_data <- read_csv('camtrap_effort.csv') %>% 
  mutate(installed = lubridate::dmy(installed),
         takedown = lubridate::dmy(takedown),
         end = lubridate::dmy(end),
         work_time = as.integer(end-installed),
         class=factor(class, levels = c('Forest','High Balsa','Medium Balsa','Low Balsa','Natural regeneration')),
         class2 = factor(class2, levels = c('Forest','Reforestation','Natural regeneration')),
         cavity_type = if_else(class=='Forest','Natural','Artificial'))

db_joint <- left_join(database,station_data, by = 'Station') 
```
# Number of detections
We remove some species we're not interested in: unidentified animals, birds, lizards, people, bats, scorpion, unidentified opossums, setup photos and dogs. 
```{r filter data}
db_joint %>% distinct(Species) %>% knitr::kable()
sp_to_remove <- c('uid','bird','lizard_uid','people','bat','scorpion', 'opossum_uid', 'setup', 'dog')
db_filtered <- db_joint %>% filter(!Species%in%sp_to_remove)

# I add a column to indicate the event number. This will allow to group into independent events.
db_filtered <- db_filtered %>% separate(col = Event, into = c("Event","event_total")) %>% 
  mutate(event = cumsum(Event=='1'))
db_indep <- db_filtered %>% distinct(event, .keep_all = T)
```
Let's get the count of independent events.
```{r spp count}
db_indep %>% group_by(Species) %>% count(cavity_type, Species) %>% pivot_wider(values_fill = 0, names_from = cavity_type, values_from = n) %>% knitr::kable()
```

In this list, some categories include multiple species. For example, the raccoon category groups the common raccoon _Procyon lotor_ and the crab-eating raccoon _P. cancrivorus_. Similarly, the rodents category includes field mice (Cricetidae), spiny rats (Echimyidae). The bats category (excluded here) possibly also includes multiple species. Species found inside the boxes include frugivore (_Carollia perspicillata_) and nectarivore phyllostomids (_Micronycteris spp._). Other common species found in the restoration plots include frugivores in the subfamily Stenodermatinae and nectarivores (_Glossophaga soricina_) [@Haave2021], but these tend to roost more often in leaves, so it's less likely that they are the ones seen in videos. 
Coatis (_Nasua narica_) were the species detected most often, followed by common opossums (_Didelphis marsupialis_). In contrast, we detected white-lipped peccaries (_Tayassu pecari_), pumas (_Puma concolor_) and margays (_Leopardus wiedii_) fewer than five times over the study period. We detected two species of primates, capuchin monkeys (_Cebus imitator_) and squirrel monkeys (_Saimiri oerstedii_), even though the the natural cavities and artificial habitats were close to the ground.

# Species richness
Plot the number of species detected for each category (using both five or three classes)
``` {r}
db_indep %>% select(class, Station, Species) %>% distinct() %>% 
  group_by(class, Station) %>% count() %>% 
  ggplot(aes(class,n))+geom_boxplot(fill='steelblue')+
  theme_classic(base_size = 16)+
  labs(x='Site category',y='Number of species detected')
db_indep %>% select(class2, Station, Species) %>% distinct() %>% 
  group_by(class2, Station) %>% count() %>% 
  ggplot(aes(class2,n))+geom_boxplot(fill='steelblue')+
  theme_classic(base_size = 16)+
  labs(x='Site category',y='Number of species detected')
```

There was a higher mean number of species detected at forest cavities, but also a larger variation, likely due to the diversity in the nature of the cavities (some were hollow trees, others were fallen logs). In contrast, the number of species detected in reforestation plots was similar across stations. If we group all the reforestation plots together then there is significant variation, but it does seem there is higher richness than in the natural regeneration plots. 
# Species diversity

```{r diversity index}
community_matrix <- db_indep %>% group_by(Station, Species) %>% count() %>% 
  pivot_wider(names_from = Species, values_from = n, values_fill = 0) 
# %>% as.data.frame() %>%   column_to_rownames('Station')
diversity(community_matrix[,-1], index = 'simpson') -> simpson_index
diversity(community_matrix[,-1], index = 'shannon') -> shannon_index
data.frame(simpson=simpson_index,shannon=shannon_index, Station = community_matrix[,1]) %>% 
  left_join(select(station_data,Station,class)) %>% 
  pivot_longer(c(simpson, shannon),names_to = 'index',values_to = 'index_value') %>% 
  ggplot(aes(class, index_value))+geom_boxplot(aes(fill=index))+
    facet_grid(~index)+
  theme_classic(base_size = 14)+
  labs(x='Site category',y='Species diversity')+
  theme(axis.text.x = element_text(angle = -35, hjust = 0))

data.frame(simpson=simpson_index,shannon=shannon_index, Station=community_matrix[,1]) %>% 
  left_join(select(station_data,Station,class2)) %>% 
  pivot_longer(c(simpson, shannon),names_to = 'index',values_to = 'index_value') %>% 
  ggplot(aes(class2, index_value))+geom_boxplot(aes(fill=index))+
    facet_grid(~index)+
  theme_classic(base_size = 18)+
  labs(x='Site category',y='Species diversity')+
  theme(axis.text.x = element_text(angle = -35, hjust = 0))
```


In addition to the species richness, we can use diversity indices to assess the similarity among plots. Diversity was higher in the forest, and in plots with an intermediate amount of Balsa trees. The remaining reforestation plots had similar diversity. The natural regeneration plots may have lower diversity.

```{r freq}
db_indep %>% group_by(class,Station,Species) %>% add_count() %>% 
  mutate(freq=n/work_time) %>% 
  select(Species,class,freq) %>% 
  distinct() %>% 
  summarise(meanfreq=mean(freq,na.rm=T)) %>% 
  ggplot(aes(class, Species))+geom_tile(aes(fill = meanfreq*7))+
  scale_fill_continuous(trans='log10', type = 'viridis')+
  theme_classic()+
  labs(fill = 'Detection frequency (per week)', x='')+
  theme(axis.text.x = element_text(angle = -35, hjust = 0))->p1

db_indep %>% group_by(class2,Station,Species) %>% count() %>% 
  left_join(select(station_data, c(Station,work_time))) %>% 
  mutate(freq=n/work_time) %>% 
  group_by(class2, Species) %>% 
  summarise(meanfreq=mean(freq)) %>% 
  ggplot(aes(class2, Species))+geom_tile(aes(fill = meanfreq*7))+
  scale_fill_continuous(trans='log10', type='viridis')+
  theme_classic()+
  labs(fill = 'Detection frequency (per week)', x='')+
  theme(axis.text.x = element_text(angle = -35, hjust = 0))->p2
plot_grid(p1,p2,ncol = 1)
```

We can analyze which species are represented in each category, using the frequency per station as a standard metric. Coatis, tamanduas (_Tamandua mexicana_), ocelots (_Leopardus pardalis_), common opossums, collared peccaries (_Pecari tajacu_) and four-eyed opossums (_Philander opossum_) were detected across all categories.
There are several species which were only detected in the forest, like striped skunks (_Conepatus semistriatus_), nine-banded armadillos (_Dasypus novemcinctus_), squirrels (Sciuridae), pumas (_Puma concolor_) and white-lipped peccaries.
In contrast, raccoons (_Procyon spp._), tapirs (_Tapirus bairdii_) and both species of monkey were only detected in the regeneration plots. In the case of the monkeys this likely has to do with the sparsity of trees, which forces them to move closer to the ground where they can be detected by camera-traps (although these species do forage often at forest edges). Some species that were detected across all categories had higher detection frequencies at stations with lower coverage, like common opossums. We observed an opposite trend, whereby species were more often seen in the forest of in areas with higher coverage for tamanduas. 

# Difference among communities
```{r nmds}
station_list <- community_matrix %>% select(Station)
nmds_spp <- metaMDS(community_matrix[,-1])
station_list %>% left_join(station_data, by='Station') %>% pull(class)->site_type
ordiplot(nmds_spp, type = 't')
ordiellipse(nmds_spp, groups = site_type)
```

The NMDS shows a clear separation of the community in forest plots (F) from the community in reforestation plots. In reforestation plots there is not a clear distinction. Species like the skunk, puma, agouti were clearly associated with forest sites, whereas others like collared peccaries, monkeys, opossums, raccoons and coatis were more strongly associated with reforestation plots. 
```{r nmds 3 cat}
station_list %>% left_join(station_data, by='Station') %>%
  pull(class2) ->site_type_2

ordiplot(nmds_spp, type = 't')
ordiellipse(nmds_spp, groups = site_type_2)
```
```{r test of differences}
summary(anosim(community_matrix[,-1], grouping = site_type))
summary(anosim(community_matrix[,-1], grouping = site_type_2))
plot(anosim(community_matrix[,-1], grouping = factor(site_type_2)))
adonis(community_matrix[,-1]~site_type_2)
```
There is a clear difference between the communities in the different types of site, using all five categories (ANOSIM $R = 0.273, p = 0.002$) or only three (ANOSIM $R = 0.514, p = 0.001$). The most dissimilar sites were the ones in the forest.

# Relationship between community composition and land cover
The previous plots were ordered assuming that the amount of coverage increased from natural regeneration to higher balsa. We can use the information we have about vegetation to see if the abundance/detection frequency are actually better described by vegetation variables.The vegetation database includes multiple variables of coverage, like the relative area covered by leaf litter, rocks, wood debris, tree trunks, grass, vegetation, and roots. It also includes the vegetation height, canopy height, and canopy cover, as well as depth of leaf litter. Some of these will naturally be correlated.

```{r import veg data}
veg_data <- readxl::read_excel('Copy of vegetation_2021.xlsx',
                               sheet = 1)
veg_joint <- station_data %>% select(Station,class,plot) %>% left_join(veg_data, by =  c('plot'='Site')) 
veg_joint %>% filter(!is.na(plot)) %>% summary()
```

```{r correlations}
cca_env <- veg_joint %>% filter(!is.na(plot)) %>% select(!starts_with(c('rock', 'root'))) %>% 
  arrange(Station) %>% 
  select(`lealit (%)`:last_col())
cor_veg <- cor(cca_env)
corrplot::corrplot(cor_veg, order = 'FPC')
```
There is a moderate to high correlation between canopy cover and the number of trees, canopy height, the amount of dead wood, the amount of leaf litter, and the cover of wood debris. These same variables are negatively correlated with the proportion of grass in the plot, and to a lesser degree with the total proportion of vegetation. Given these correlations, it makes sense to group them into principal components.
```{r PCA}
veg_pca <- prcomp(cca_env)
biplot(veg_pca)
veg_pca$rotation[,1:2]
```

The main variables along the first principal component are the proportion of grass and tree trunks (positive), the proportion of total vegetation, number of trees, amount of leaf litter (negative). The second PC represents leaf litter percentage and canopy cover. We can use the first two principal components in a Canonical Correspondence Analysis to associate the species composition with these environmental variables.
```{r cca}
prin_comps <- predict(veg_pca)[,1:2] %>% as.data.frame()
cca_spp <- db_indep %>% group_by(Station, Species) %>% filter(!is.na(plot)) %>% 
  count() %>% 
  pivot_wider(names_from = Species, values_from = n, values_fill = 0) %>% 
  ungroup() %>%   select(-Station)
# names(prin_comps) <- c('total_veg','prop_forest')
plot(cca(cca_spp~PC1+PC2, data=prin_comps), display = c('bp','sp'))
```

Species like tayra, capuchins, and tapirs are oriented along the first PC, they are associated with higher grass cover. Rodents and agoutis are associated with the second PC, they are therefore associated more with higher leaf litter and canopy cover. Raccoons, ocelots and squirrel monkeys are negatively associated with the second PC, meaning they are associated with areas with fewer trees. Most remaining species were near the middle of the plot, meaning they are not responding to these variables significantly. 

# Types of uses of cavities
We need to consider which species are in fact interacting with the cavities or artificial habitats. Some analysis that we will include:
* Which species use cavities as refuge, which only to forage
* Average time spent each visit.
* Number of individuals
* Delays after a different species used it as refuge.

```{r behavior database}
# First, we need to categorize each individual event, whether it constitutes an interaction or not. Before I need to change some codes. Then I create lists of terms that contemplate whether animals enter the cavity, to search in the behavior string. 
db_filtered <- db_filtered %>% mutate(Behaviour = str_replace(Behaviour,'in cavity', 'inside'))
inside_terms <- c('entering','inside','exiting')
interaction_terms <- c('entrance','leg','base','bottom','inspecting')
marking_terms <- c('urinating','defecating','marking','rubbing')
eating_terms <- c('feeding','food','prey','foraging')
no_interaction_terms <- c('passing','crossing')
#Now I create the behavior database, summarising the main database looking for key terms in the description.
db_behav <- db_filtered  %>% 
  rowwise() %>%
  # separate_rows(Behaviour, sep=',') %>% 
  # mutate(Behaviour=str_squish(Behaviour)) %>% 
  mutate(enters = any(!is.na(str_match(Behaviour,c('entering','inside')))),
         exits = any(!is.na(str_match(Behaviour, 'exiting'))),
         interacts = any(!is.na(str_match(Behaviour, interaction_terms))),
         marks = any(!is.na(str_match(Behaviour, marking_terms))),
         eats = any(!is.na(str_match(Behaviour, eating_terms))),
         passes = any(!is.na(str_match(Behaviour, no_interaction_terms)))) %>% 
  group_by(event) %>% 
  summarise(entrance=any(enters),
            exit=any(exits),
            in_n_out = any(enters) & any(exits),
            interaction=any(interacts),
            mark = any(marks),
            eat = any(eats),
            pass = any(passes),
            event_start = min(DateTime),
            event_dur=max(DateTime)-min(DateTime),
            n_ind = max(SpNumber)) %>% 
  left_join(select(db_filtered, c(event,Station, Species, class, class2, cavity_type)), by = 'event') %>% 
  distinct() %>% 
  arrange(Station, Species, event_start)
```
```{r behavior summary}
db_behav %>% group_by(Species, cavity_type) %>% summarise(n_events=n(),
                                                          prop_enter=sum(entrance)/n(), 
                                                          prop_exit=sum(exit)/n(), 
                                                          prop_io=sum(in_n_out)/n(), 
                                                          prop_inter=sum(interaction)/n(), 
                                                          prop_mark=sum(mark)/n(), 
                                                          prop_eat=sum(eat)/n(), 
                                                          prop_pass=sum(pass)/n()) %>% 
  knitr::kable(digits = 2)
```
Coatis, common opossums and ocelots interact frequently with cavities, both natural cavities and artificial habitats. In both cases they regularly inspect and go into the cavities. Coatis entered the cavities roughly 60% of all detections, ocelots between 62% and 72%, and common opossums between 16% and 38%.
Some species are unable to enter the artificial habitats, even though they interact with them, for example peccaries, agoutis and pacas. Pacas and agoutis had almost no interaction with artificial habitats, while peccaries occasionally inspect the artificial habitats. We also observed collared peccaries using artificial habitats to shelter from the rain. Agoutis do go into natural cavities regularly (38% of detections).
Tamanduas and tayras only entered natural cavities. They were detected in the reforestation plots but never interacted with the artificial habitats.
```{r visit duration}
db_behav %>% filter(entrance) %>% 
  group_by(Species, cavity_type) %>% summarise(mean_dur = mean(event_dur)) %>% 
  pivot_wider(names_from = cavity_type, values_from = mean_dur) %>% 
  knitr::kable(digits = 1, caption = 'Mean time spent at cavities and artificial habitats by different species')
```
Coatis and common opossums spend longer at natural cavities on average, likely because there are more food items in natural cavities, and it takes longer to explore the cavity. Coatis on average spent more than five times longer, while opossums spent more than double the time. Ocelots in contrast spent twice as much inside artificial habitats than in natural cavities (I need to refine this analysis, as the data currently might consider entrances and exits as separate events). 
```{r}
db_behav %>% filter(eat) %>% count(Species, cavity_type) %>% 
  arrange(desc(n)) %>% 
  pivot_wider(names_from = cavity_type, values_from = n, values_fill = 0) %>% 
  knitr::kable(caption = 'Number of feeding or foraging events observed per species')
```
We observed 15 species feeding/foraging in or around cavities. The most frequently observed were agoutis (26 times) and coatis (33). Agoutis, tamanduas, armadillos, skunks and rodents were only seen feeding/foraging in forest cavities. Tamanduas, armadillos, and skunks have similar insectivore diets, and they can forage in the soil inside hollow or fallen trees. Tamanduas and coatis can additionally forage inside the dead wood inside hollow trees. We observed agoutis caching and recovering fruits and seeds near the entrance of standing tree cavities. We observed coatis feeding or foraging both in the forest and around artificial habitats. 

```{r short entrances}
db_behav %>% filter(entrance) %>% count(Species, in_n_out) %>% pivot_wider(names_from = in_n_out, values_from = n) %>%
  knitr::kable(caption = 'Short entrances for different species')
```
For ocelots, collared peccaries, raccoons, and tayras, they only enter cavities briefly, and come out almost immediately after. They are only exploring for food and not for shelter.

# References
